<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZEBROL</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-black text-white">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

firebase.initializeApp({
  apiKey: "AIzaSyBAH2rBIR5ibvde0VMVF38QyM4L2s8IqIQ",
  authDomain: "zebrol.firebaseapp.com",
  projectId: "zebrol",
  appId: "1:846397475446:web:1b38ce35dcae4e1754ed57"
});

const auth = firebase.auth();
const db = firebase.firestore();

function App() {
  const [user, setUser] = useState(null);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");

  const [items, setItems] = useState([]);
  const [selected, setSelected] = useState(null);
  const [showForm, setShowForm] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [confirmDelete, setConfirmDelete] = useState(false);

  const [searchOpen, setSearchOpen] = useState(false);
  const [search, setSearch] = useState("");

  const emptyForm = {
    image:"",
    name:"",
    vulgo:"",
    faction:"",
    cpf:"",
    birth:"",
    mother:"",
    infopem:"",
    address:"",
    description:""
  };

  const [form, setForm] = useState(emptyForm);

  useEffect(() => auth.onAuthStateChanged(setUser), []);

  useEffect(() => {
    if (!user) return;
    return db.collection("users")
      .doc(user.uid)
      .collection("items")
      .onSnapshot(snap => {
        setItems(snap.docs.map(d => ({ id:d.id, ...d.data() })));
      });
  }, [user]);

  const handleChange = e => {
    const { name, value, files } = e.target;
    if (files && files[0]) {
      const r = new FileReader();
      r.onload = () => setForm(f => ({ ...f, [name]: r.result }));
      r.readAsDataURL(files[0]);
    } else {
      setForm(f => ({ ...f, [name]: value }));
    }
  };

  const saveItem = async () => {
    const ref = db.collection("users").doc(user.uid).collection("items");
    editingId ? await ref.doc(editingId).update(form) : await ref.add(form);
    setForm(emptyForm);
    setEditingId(null);
    setShowForm(false);
  };

  const deleteItem = async () => {
    await db.collection("users")
      .doc(user.uid)
      .collection("items")
      .doc(selected.id)
      .delete();
    setConfirmDelete(false);
    setSelected(null);
  };

  const filtered = items
    .filter(i =>
      [i.name,i.vulgo,i.faction]
        .some(v => v?.toLowerCase().includes(search.toLowerCase()))
    )
    .sort((a,b)=>a.name.localeCompare(b.name,"pt-BR",{sensitivity:"base"}));

  if (!user) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center gap-4">
        <h1 className="text-3xl font-bold">ZEBROL</h1>
        <input className="bg-gray-800 p-2 rounded w-64" placeholder="Email" onChange={e=>setEmail(e.target.value)} />
        <input type="password" className="bg-gray-800 p-2 rounded w-64" placeholder="Senha" onChange={e=>setPassword(e.target.value)} />
        <button onClick={()=>auth.signInWithEmailAndPassword(email,password)} className="bg-blue-600 px-4 py-2 rounded">
          Entrar
        </button>
      </div>
    );
  }

  return (
    <div className="min-h-screen p-6 space-y-6">
      <h1 className="text-3xl font-bold text-center">ZEBROL</h1>

      {showForm && (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
          <div className="bg-gray-900 p-4 rounded w-full max-w-sm space-y-2">
            <input type="file" name="image" onChange={handleChange} />

            <input className="w-full bg-gray-800 p-2 rounded" name="name" placeholder="Nome" value={form.name} onChange={handleChange} />
            <input className="w-full bg-gray-800 p-2 rounded" name="vulgo" placeholder="Vulgo" value={form.vulgo} onChange={handleChange} />
            <input className="w-full bg-gray-800 p-2 rounded" name="faction" placeholder="Facção" value={form.faction} onChange={handleChange} />
            <input className="w-full bg-gray-800 p-2 rounded" name="cpf" placeholder="CPF" value={form.cpf} onChange={handleChange} />

            <input className="w-full bg-gray-800 p-2 rounded" name="birth" placeholder="Data de nascimento" value={form.birth} onChange={handleChange} />

            <input className="w-full bg-gray-800 p-2 rounded" name="mother" placeholder="Nome da mãe" value={form.mother} onChange={handleChange} />
            <input className="w-full bg-gray-800 p-2 rounded" name="infopem" placeholder="Infopem" value={form.infopem} onChange={handleChange} />

            <input className="w-full bg-gray-800 p-2 rounded" name="address" placeholder="Endereço" value={form.address} onChange={handleChange} />
            <textarea className="w-full bg-gray-800 p-2 rounded" name="description" placeholder="Descrição" value={form.description} onChange={handleChange} />

            <button onClick={saveItem} className="w-full bg-blue-600 p-2 rounded">Salvar</button>
            <button onClick={()=>{ setShowForm(false); setEditingId(null); }} className="w-full bg-gray-700 p-2 rounded">Cancelar</button>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
