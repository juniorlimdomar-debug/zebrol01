<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZEBROL</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase CDN (v9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-black text-white">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    /* FIREBASE CONFIG */
    const firebaseConfig = {
      apiKey: "AIzaSyBAH2rBIR5ibvde0VMVF38QyM4L2s8IqIQ",
      authDomain: "zebrol.firebaseapp.com",
      projectId: "zebrol",
      appId: "1:846397475446:web:1b38ce35dcae4e1754ed57"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function App() {
      const [user, setUser] = useState(null);
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");

      const [items, setItems] = useState([]);
      const [selected, setSelected] = useState(null);
      const [showForm, setShowForm] = useState(false);
      const [editId, setEditId] = useState(null);
      const [search, setSearch] = useState("");

      const emptyForm = {
        image: "",
        name: "",
        vulgo: "",
        faction: "",
        cpf: "",
        birth: "",
        mother: "",
        address: "",
        description: ""
      };

      const [form, setForm] = useState(emptyForm);

      /* AUTH STATE */
      useEffect(() => {
        return auth.onAuthStateChanged(u => setUser(u));
      }, []);

      /* LOAD DATA */
      useEffect(() => {
        if (!user) return;

        return db
          .collection("users")
          .doc(user.uid)
          .collection("items")
          .onSnapshot(snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setItems(data);
          });
      }, [user]);

      /* LOGIN */
      const login = async () => {
        try {
          await auth.signInWithEmailAndPassword(email, password);
        } catch (e) {
          alert("Erro ao entrar");
        }
      };

      const logout = () => auth.signOut();

      /* FORM */
      const handleChange = (e) => {
        const { name, value, files } = e.target;
        if (files && files[0]) {
          const reader = new FileReader();
          reader.onload = () => setForm(prev => ({ ...prev, [name]: reader.result }));
          reader.readAsDataURL(files[0]);
        } else {
          setForm(prev => ({ ...prev, [name]: value }));
        }
      };

      const saveItem = async () => {
        if (editId) {
          await db.collection("users").doc(user.uid).collection("items").doc(editId).set(form);
        } else {
          await db.collection("users").doc(user.uid).collection("items").add(form);
        }
        setForm(emptyForm);
        setEditId(null);
        setShowForm(false);
      };

      const deleteItem = async (id) => {
        await db.collection("users").doc(user.uid).collection("items").doc(id).delete();
        setSelected(null);
      };

      /* LOGIN UI */
      if (!user) {
        return (
          <div className="min-h-screen flex flex-col items-center justify-center gap-4">
            <h1 className="text-3xl font-bold">ZEBROL</h1>
            <input className="bg-gray-800 p-2 rounded w-64" placeholder="Email" onChange={e => setEmail(e.target.value)} />
            <input type="password" className="bg-gray-800 p-2 rounded w-64" placeholder="Senha" onChange={e => setPassword(e.target.value)} />
            <button onClick={login} className="bg-blue-600 px-4 py-2 rounded">Entrar</button>
          </div>
        );
      }

      const filtered = items
        .filter(i =>
          i.name.toLowerCase().includes(search.toLowerCase()) ||
          i.vulgo.toLowerCase().includes(search.toLowerCase()) ||
          i.faction.toLowerCase().includes(search.toLowerCase())
        )
        .sort((a,b)=>a.name.localeCompare(b.name,"pt-BR",{sensitivity:"base"}));

      return (
        <div className="p-6 space-y-6">
          <h1 className="text-3xl font-bold text-center">ZEBROL</h1>

          <input className="w-full max-w-md mx-auto block bg-gray-900 p-2 rounded"
            placeholder="Pesquisar"
            value={search}
            onChange={e => setSearch(e.target.value)}
          />

          <div className="grid grid-cols-2 gap-4 max-w-md mx-auto">
            {filtered.map(item => (
              <div key={item.id} onClick={()=>setSelected(item)} className="bg-gray-900 p-4 rounded cursor-pointer">
                <div className="h-32 bg-gray-700 rounded mb-2 overflow-hidden">
                  {item.image && <img src={item.image} className="w-full h-full object-cover"/>}
                </div>
                <p className="text-center">{item.name}</p>
              </div>
            ))}
          </div>

          <button onClick={()=>setShowForm(true)} className="fixed bottom-6 right-6 bg-blue-600 w-14 h-14 rounded-full text-3xl">+</button>
          <button onClick={logout} className="fixed top-4 right-4 text-sm text-red-400">Sair</button>

          {showForm && (
            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
              <div className="bg-gray-900 p-4 rounded space-y-2 w-full max-w-sm">
                <input type="file" name="image" onChange={handleChange}/>
                {["name","vulgo","faction","cpf","birth","mother","address"].map(f=>(
                  <input key={f} name={f} value={form[f]} onChange={handleChange}
                    placeholder={f} className="w-full bg-gray-800 p-2 rounded"/>
                ))}
                <textarea name="description" value={form.description} onChange={handleChange}
                  className="w-full bg-gray-800 p-2 rounded"/>
                <button onClick={saveItem} className="bg-blue-600 w-full p-2 rounded">Salvar</button>
              </div>
            </div>
          )}

          {selected && (
            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
              <div className="bg-gray-900 p-4 rounded w-full max-w-sm space-y-2">
                {selected.image && <img src={selected.image} className="w-full object-contain"/>}
                <p><b>Nome:</b> {selected.name}</p>
                <p><b>Vulgo:</b> {selected.vulgo}</p>
                <p><b>Facção:</b> {selected.faction}</p>
                <button onClick={()=>deleteItem(selected.id)} className="text-red-500">Excluir</button>
                <button onClick={()=>setSelected(null)} className="text-gray-400">Fechar</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
